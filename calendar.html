<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>calendar</title>
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Playfair+Display" />
<link rel="stylesheet" type="text/css" href="css/index.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/locale/ko.js"></script>
<script>
	//.format('YYYY-MM-DD hh:mm');
	var now_month = moment();
	var selected_day = '';
	var $schedule;
	var $input;
	var cal = [];
	cal[0] = [];

	var select_time = '';
	var $alarmList;
	var localSt = localStorage.getItem('alram');

	window.onload = function(){


		setInterval(()=>{
			
			// for(var i=0; alarm.length; i++){
			// 	// var test = moment('2019-03-02 14:51:00');
			// 	var test = moment(alarm[i]);
				
			// 	if(test != null && test.isBefore(time)){
			// 		alarm.splice(i, 1);
			// 		console.log("알림!!!");
			// 	}
				
			// }
			a_time();
			
		}, 1000);

		$input = $('#input');
		$alarmList = $('#alarm_list');

		alarm_fuc();
		cal_fuc(now_month);
	}

	function a_time(){
		var time = moment();
		
		alarm = JSON.parse(localSt);
		select_time = time.format('LTS');
		$('#a_time').text(select_time);
		
		var al_str = '';
		var change_flag = false;

		if(localSt != undefined && localSt != ''){
			for(var j=0; j<alarm.length; j++){
				if(alarm[j] == select_time){
					alert('alram');
					alarm.splice(j, 1);
					change_flag = true;
				}
			}
		}
		if(change_flag){
			localStorage.setItem('alram', JSON.stringify(alarm));
			localSt =JSON.stringify(alarm);
			for(var j=0; j<alarm.length; j++){
				al_str += `<li>${alarm[j]}</li>`
			}

			$alarmList.html(al_str);
		}
		
	

	}

	function alarm_fuc(){
		var time = moment();
		var $ai_btn = $('#ai_btn');
		
		select_time = time.format('LTS');

		$('#a_time').text(select_time);

		$ai_btn.on('click', function(){
			alarm_save();
		});

		alarm = JSON.parse(localSt);

		var al_str = '';

		if(localSt != undefined && localSt != ''){
			for(var j=0; j<alarm.length; j++){
				al_str += `<li>${alarm[j]}</li>`
			}
		}
		
		$alarmList.html(al_str);
	}

	function alarm_save(){
		var alarm = [];
		var $aInput = $('#a_input');
		
		if(localSt != undefined && localSt != ''){
			alarm = JSON.parse(localSt);
			alarm.push($aInput.val());
		}else{
			alarm[0] = $aInput.val();
		}
		
		localStorage.setItem('alram', JSON.stringify(alarm));
		localSt =JSON.stringify(alarm);

		var al_str = '';

		for(var j=0; j<alarm.length; j++){
			al_str += `<li>${alarm[j]}</li>`
		}

		$alarmList.html(al_str);
		console.log(alarm);
		
	}

	function cal_fuc(calf){

		$.ajax({
			url:'https://c97q48g7ui.execute-api.ap-northeast-2.amazonaws.com/dev/apitest',
			method:'post',
			dataType:'json',
			data: JSON.stringify({
				'url':'http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo',
				'method':'get',
				'querystring':{
					'solYear': calf.format('YYYY'),
					'solMonth': calf.format('MM'),
					'ServiceKey':'lRXTaLfFt0hq2g7EnVQbuGAQ2K9tI7fryCPIuwfp6wkrlTLbHtlk0eISiasOMSNVhS5jMm0gfXmcBdQ0gVPV5A%3D%3D',
					'_type':'json'
				}
				
			}),
			success: function(data){
				data_view(calf);
				holy_day(data);
			},
			error:function(error){
				console.log(error);
			}
		});
		
	}

	function holy_day(holy){
		var con = '';
		var diI = holy.items.item;

		for(var i in diI){
			con += `<tr>`
			for(var j in diI[i]){
				con += `<td>${diI[i][j]}</td>`
			}
			con += `</tr>`
		}

		$('#lim_t').html(con);

	}

	function data_view(input){
		
		cal = [];
		cal[0] = [];
		var date = input.startOf('month');
		var dow = date.weekday();
		var max_days = input.daysInMonth();
		var str = '';
		var week = 0;
		
		str += `<tr>`

		for(var i=0; i<dow; i++){
			cal[week].push('');
			str += `<td><div class="day-contents">&nbsp;</div></td>`
		}
		
		for(var j=1; j<=max_days; j++){

			var inputF = input.format('YYYYMM') + j;

			if(inputF.substr(6, 2) < 10){
				inputF = input.format('YYYYMM') + '0' + j;
			}

			var loca_inF = localStorage.getItem(inputF);

			if(loca_inF != undefined && loca_inF != ''){
				str += `<td><div id="day${j}" class="day-contents schedule" onclick="modal(${j});">${j}</div></td>`
				cal[week].push({'memo': loca_inF, 'day': j});
				
			}else{
				str += `<td><div id="day${j}" class="day-contents" onclick="modal(${j});">${j}</div></td>`
				cal[week].push({'memo': false, 'day': j});
			}
			
			if(dow % 7 === 6){
				if(j != max_days ){ //|| (dow + 1) % 7 != 0
					week++;
					cal[week] = [];
					
				}
				str += `</tr><tr>`
			}
			dow++;
		}

		for(var k=dow; k % 7 !== 0; k++){
			cal[week].push('');
			str += `<td><div class="day-contents">&nbsp;</div></td>`
		}

		str += `</tr>`

		document.getElementById('calendar2').innerHTML = str;
		document.getElementById('str_cal').innerHTML = input.format('YYYY MM');
	}

	function upmonth(){
		now_month = now_month.add(1, 'month');
		cal_fuc(now_month);
	}

	function downmonth(){
		now_month = now_month.add(-1, 'month');
		cal_fuc(now_month);
	}

	function modal(day){
		$schedule = $('#schedule');

		if(day < 10){
			day = '0' + day;
		}
		
		selected_day = now_month.format('YYYYMM') + day;
		
		$('#modal').show();
		
		// var text_str = '';
		var local_gs = localStorage.getItem(selected_day);

		drawing_list(sch_list);


		if(local_gs != undefined){
			var sch_list = JSON.parse(local_gs);
			drawing_list(sch_list);

			// for(var i =0; i < sch_list.length; i++){
			// 	text_str += `<div id="schlist${i}">`
			// 		text_str += `<p>- ${sch_list[i]}</p>`
			// 		text_str += `<div class="btn_ml">`
			// 			text_str += `<button type="button" onclick="delete_spc_list(${i});">삭제</button>`
			// 			text_str += `<button type="button" onclick="modify_spc_list(${i});">수정</button>`
			// 			text_str += `<button type="button" onclick="modifySave(${i});">저장</button>`
			// 		text_str += `</div>`
			// 	text_str += `</div>`
			// }
		}
 		
		// $schedule.html(text_str);
		console.log(sch_list);
	}

	function save(){
		// $input = $('#input');
		var set_local = [];

		var local_gs = localStorage.getItem(selected_day);
		if(local_gs != undefined && local_gs != ''){
			set_local = JSON.parse(local_gs);
			set_local.push($input.val());
			console.log(set_local);
		}else{
			set_local[0] = $input.val();
		}

		localStorage.setItem(selected_day, JSON.stringify(set_local));

		drawing_list(set_local);
		// var text_str = '';

		// for(var i=0; i < set_local.length; i++){
		// 	text_str += `<div id="schlist${i}">`
		// 		text_str += `<p>- ${set_local[i]}</p>`
		// 		text_str += `<div class="btn_ml">`
		// 			text_str += `<button type="button" onclick="delete_spc_list(${i});">삭제</button>`
		// 			text_str += `<button type="button" onclick="modify_spc_list(${i});">수정</button>`
		// 			text_str += `<button type="button" onclick="modifySave(${i});">저장</button>`
		// 		text_str += `</div>`
		// 	text_str += `</div>`
		// }

		// $schedule.html(text_str);

		$input.val('');

		var day_for_class = selected_day.substr(6, 1) == '0' ? selected_day.substr(7, 1) : selected_day.substr(6, 2);
		$('#day'+ day_for_class).addClass('schedule');
		//console.log(day_for_class);
	}

	function sDelete(){
		localStorage.removeItem(selected_day);
		$schedule.text('');
		
		var day_for_class = selected_day.substr(6, 1) == '0' ? selected_day.substr(7, 1) : selected_day.substr(6, 2);
		$('#day'+ day_for_class).removeClass('schedule');
	}

	function delete_spc_list(number){
		set_local = JSON.parse(localStorage.getItem(selected_day));
		set_local.splice(number, 1);
		console.log(set_local);

		localStorage.setItem(selected_day, JSON.stringify(set_local));


		drawing_list(set_local);
		// var text_str = '';

		// for(var i=0; i < set_local.length; i++){
		// 	text_str += `<div id="schlist${i}">`
		// 		text_str += `<p>- ${set_local[i]}</p>`
		// 		text_str += `<div class="btn_ml">`
		// 			text_str += `<button type="button" onclick="delete_spc_list(${i});">삭제</button>`
		// 			text_str += `<button type="button" onclick="modify_spc_list(${i});">수정</button>`
		// 			text_str += `<button type="button" onclick="modifySave(${i});">저장</button>`
		// 		text_str += `</div>`
		// 	text_str += `</div>`
		// }

		// $schedule.html(text_str);

		// console.log(number);
	}

	function modify_spc_list(number){
		// $input = $('#input');

		set_local = JSON.parse(localStorage.getItem(selected_day));
		$input.val(set_local[number]);
	}

	function modifySave(number){
		set_local = JSON.parse(localStorage.getItem(selected_day));
		set_local[number] = $input.val();
		localStorage.setItem(selected_day, JSON.stringify(set_local));

		$('#schlist'+ number).find('p').text('- '+ $input.val());
	}

	function drawing_list(list){
		var text_str = '';

		for(var i=0; i < list.length; i++){
			text_str += `<div id="schlist${i}">`
				text_str += `<p>- ${list[i]}</p>`
				text_str += `<div class="btn_ml">`
					text_str += `<button type="button" onclick="delete_spc_list(${i});">삭제</button>`
					text_str += `<button type="button" onclick="modify_spc_list(${i});">수정</button>`
					text_str += `<button type="button" onclick="modifySave(${i});">저장</button>`
				text_str += `</div>`
			text_str += `</div>`
		}

		$schedule.html(text_str);
	}

</script>
</head>
<body>
<div class="cal1">
	<div class="clndr">
		<div class="clndr-controls">
			<div class="clndr-control-button">
				<p class="clndr-previous-button"onclick="downmonth();">previous</p>
			</div>
			<div id="str_cal" class="month"></div>
			<div class="clndr-control-button rightalign">
				<p class="clndr-next-button" onclick="upmonth();">next</p>
			</div>
		</div>
		<table id="calendar" class="clndr-table">
			<thead>
				<tr class="header-days">
					<th class="header-day">Sun</th>
					<th class="header-day">Mon</th>
					<th class="header-day">Tue</th>
					<th class="header-day">Wed</th>
					<th class="header-day">Thu</th>
					<th class="header-day">Fri</th>
					<th class="header-day">Sat</th>
				</tr>
			</thead>
			<tbody id="calendar2">
			</tbody>
		</table>
	</div>
</div>
<div id="modal">
	<div id="schedule"></div>
	<div class="input_box">
		<input type="text" id="input">
	</div>

	<div class="btn_line">

		<div class="save">
			<button type="button" onclick="save();">저장</button>
		</div>

		<div class="all_delete">
			<button type="button" onclick="sDelete();">모두삭제</button>
		</div>

	</div>

</div>

<div id="alarm">
	<div id="a_time"></div>
	<div id="alarm_list">
		<ul></ul>
	</div>
	<div id="a_input_line">
		<input id="a_input" type="text">
		<button type="button" id="ai_btn">저장</button>
	</div>
</div>

<table id="lim_t">
</table>
</body>
</html>